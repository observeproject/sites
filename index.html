<!doctype html><html><head><meta name=generator content="Hugo 0.123.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=alternate type=application/rss+xml href=https://stack.observability.udmire.cn/index.xml title="Mixins for Observability Stack"><link rel=canonical href=https://stack.observability.udmire.cn/><title>Observability Stack Mixins | Mixins for Observability Stack
</title><link href=https://stack.observability.udmire.cn/css/fontawesome.min.css rel=stylesheet><link rel=stylesheet href=https://stack.observability.udmire.cn/css/ace.min.css></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow sticky-top" id=navbarMain><div class=container><div><a class=navbar-brand href=/>Mixins for Observability Stack</a></div><button class="navbar-toggler navbar-toggler-right collapsed" type=button data-toggle=collapse data-target=#navbarMainCollapse aria-controls=navbarMainCollapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMainCollapse><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/>Homepage</a></li><li class=nav-item><a class=nav-link href=https://github.com/monitoring-mixins/docs>About mixins</a></li><li class=nav-item><a class=nav-link href=https://github.com/observeproject/sites>GitHub</a></li></ul></div></div><div class=feed-icons><a href=https://stack.observability.udmire.cn/index.xml><img src=/img/feed-icon.svg alt="RSS feed"></a></div></nav><div class=container-fluid><div class=row><div class="docs-sidenav order-0 col-12 col-md-3 col-lg-2 col-xl-2 position-sticky border-right"><nav class="navbar navbar-expand-md navbar-light pl-0"><button class="navbar-toggler navbar-toggler-right collapsed" type=button data-toggle=collapse data-target=#sidenav-left-collapse aria-controls=sidenav-left-collapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse align-items-start flex-column" id=sidenav-left-collapse><ul class="navbar-nav flex-column pt-3"><li data-nav-id=/cert-manager/ class="nav-item my-1"><a class="nav-link p-0" href=/cert-manager/><h6>cert-manager</h6></a></li><li data-nav-id=/coredns/ class="nav-item my-1"><a class="nav-link p-0" href=/coredns/><h6>coredns</h6></a></li><li data-nav-id=/etcd/ class="nav-item my-1"><a class="nav-link p-0" href=/etcd/><h6>etcd</h6></a></li><li data-nav-id=/grafana/ class="nav-item my-1"><a class="nav-link p-0" href=/grafana/><h6>grafana</h6></a></li><li data-nav-id=/grafana-agent/ class="nav-item my-1"><a class="nav-link p-0" href=/grafana-agent/><h6>grafana-agent</h6></a></li><li data-nav-id=/kube-state-metrics/ class="nav-item my-1"><a class="nav-link p-0" href=/kube-state-metrics/><h6>kube-state-metrics</h6></a></li><li data-nav-id=/kubernetes/ class="nav-item my-1"><a class="nav-link p-0" href=/kubernetes/><h6>kubernetes</h6></a></li><li data-nav-id=/loki/ class="nav-item my-1"><a class="nav-link p-0" href=/loki/><h6>loki</h6></a></li><li data-nav-id=/memcached/ class="nav-item my-1"><a class="nav-link p-0" href=/memcached/><h6>memcached</h6></a></li><li data-nav-id=/mimir/ class="nav-item my-1"><a class="nav-link p-0" href=/mimir/><h6>mimir</h6></a></li><li data-nav-id=/node-exporter/ class="nav-item my-1"><a class="nav-link p-0" href=/node-exporter/><h6>node-exporter</h6></a></li><li data-nav-id=/pyroscope/ class="nav-item my-1"><a class="nav-link p-0" href=/pyroscope/><h6>pyroscope</h6></a></li><li data-nav-id=/tempo/ class="nav-item my-1"><a class="nav-link p-0" href=/tempo/><h6>tempo</h6></a></li></ul></div></nav></div><div class="docs-toc large order-lg-2 order-md-0 order-xs-1 col-12 col-lg-3 col-xl-3 position-sticky border-left"><div class=docs-toc><nav id=TableOfContents><ul><li><a href=#how-to-use-mixins>How to use mixins.</a></li><li><a href=#generate-config-files>Generate config files</a></li><li><a href=#using-with-prometheus-ksonnet>Using with prometheus-ksonnet</a></li><li><a href=#using-kube-prometheus>Using kube-prometheus</a></li><li><a href=#customising-the-mixin>Customising the mixin</a></li><li><a href=#guidelines-for-alert-names-labels-and-annotations>Guidelines for alert names, labels, and annotations</a></li></ul></nav></div></div><div class="main col-12 order-1 col-md-9 col-lg-9 col-xl-7 py-3"><h1>Observability Stack Mixins</h1><p>A mixin is a set of Grafana dashboards and Prometheus rules and alerts, packaged together in a reuseable and extensible bundle.
Mixins are written in <a href=https://jsonnet.org/>jsonnet</a>, and are typically installed and updated with <a href=https://github.com/jsonnet-bundler/jsonnet-bundler>jsonnet-bundler</a>.</p><p>For more information about mixins, see:</p><ul><li><a href=https://docs.google.com/document/d/1A9xvzwqnFVSOZ5fD3blKODXfsat5fg6ZhnKu9LK3lB4/view>Prometheus Monitoring Mixins Design Doc</a>. A <a href=design.pdf>cached pdf</a> is included in monitoring mixins <a href=https://github.com/monitoring-mixins/docs>documentation repository</a>.</li><li>For more motivation, see
&ldquo;<a href="https://kccncna17.sched.com/event/CU8K/the-red-method-how-to-instrument-your-services-b-tom-wilkie-kausal?iframe=no&amp;w=100%25&amp;sidebar=yes&amp;bg=no">The RED Method: How to instrument your services</a>&rdquo; talk from CloudNativeCon Austin 2018. The KLUMPs system demo&rsquo;d became the basis for the kubernetes-mixin.</li><li>&ldquo;<a href="https://www.youtube.com/watch?v=b7-DtFfsL6E">Prometheus Monitoring Mixins: Using Jsonnet to Package Together Dashboards, Alerts and Exporters</a>&rdquo; talk from CloudNativeCon Copenhagen 2018.</li><li>&ldquo;<a href=https://promcon.io/2018-munich/talks/prometheus-monitoring-mixins/>Prometheus Monitoring Mixins: Using Jsonnet to Package Together Dashboards, Alerts and Exporters</a>&rdquo; talk from PromCon 2018 (slightly updated).</li></ul><h2 id=how-to-use-mixins>How to use mixins.</h2><p>Mixins are designed to be vendored into the repo with your infrastructure config.
To do this, use <a href=https://github.com/jsonnet-bundler/jsonnet-bundler>jsonnet-bundler</a>:</p><p>You then have three options for deploying your dashboards</p><ol><li>Generate the config files and deploy them yourself.</li><li>Use ksonnet to deploy this mixin along with Prometheus and Grafana.</li><li>Use kube-prometheus to deploy this mixin.</li></ol><h2 id=generate-config-files>Generate config files</h2><p>You can manually generate the alerts, dashboards and rules files, but first you
must install some tools:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go get github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># macOS</span>
</span></span><span style=display:flex><span>$ brew install jsonnet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Archlinux AUR</span>
</span></span><span style=display:flex><span>$ yay -S jsonnet
</span></span></code></pre></div><p>Then, grab the mixin and its dependencies:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git clone https://github.com/&lt;mixin org&gt;/&lt;mixin repo&gt;
</span></span><span style=display:flex><span>$ <span style=color:#111>cd</span> &lt;mixin repo&gt;
</span></span><span style=display:flex><span>$ jb install
</span></span></code></pre></div><p>Finally, build the mixin:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ make prometheus_alerts.yaml
</span></span><span style=display:flex><span>$ make prometheus_rules.yaml
</span></span><span style=display:flex><span>$ make dashboards_out
</span></span></code></pre></div><p>The <code>prometheus_alerts.yaml</code> and <code>prometheus_rules.yaml</code> file then need to passed
to your Prometheus server, and the files in <code>dashboards_out</code> need to be imported
into you Grafana server. The exact details will depending on how you deploy your
monitoring stack to Kubernetes.</p><h2 id=using-with-prometheus-ksonnet>Using with prometheus-ksonnet</h2><p>Alternatively you can also use the mixin with
<a href=https://github.com/grafana/jsonnet-libs/tree/master/prometheus-ksonnet>prometheus-ksonnet</a>,
a <a href=https://github.com/ksonnet/ksonnet>ksonnet</a> module to deploy a fully-fledged
Prometheus-based monitoring system for Kubernetes:</p><p>Make sure you have at least ksonnet v0.8.0:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ brew install ksonnet/tap/ks
</span></span><span style=display:flex><span>$ ks version
</span></span><span style=display:flex><span>ksonnet version: 0.13.1
</span></span><span style=display:flex><span>jsonnet version: v0.11.2
</span></span><span style=display:flex><span>client-go version: kubernetes-1.10.4
</span></span></code></pre></div><p>In your config repo, if you don&rsquo;t have a ksonnet application, make a new one (will copy credentials from current context):</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ks init &lt;application name&gt;
</span></span><span style=display:flex><span>$ <span style=color:#111>cd</span> &lt;application name&gt;
</span></span><span style=display:flex><span>$ ks env add default
</span></span></code></pre></div><p>Grab the kubernetes-jsonnet module using and its dependencies, which include
the kubernetes-mixin:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go get github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb
</span></span><span style=display:flex><span>$ jb init
</span></span><span style=display:flex><span>$ jb install github.com/kausalco/public/prometheus-ksonnet
</span></span></code></pre></div><p>Assuming you want to run in the default namespace (&rsquo;environment&rsquo; in ksonnet parlance), add the follow to the file <code>environments/default/main.jsonnet</code>:</p><div class=position-relative><div class=position-absolute style=right:0><button class="btn btn-light" data-clipboard-target=#clipboard_7f0ea4f549>
Copy</button></div><div id=clipboard_7f0ea4f549><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-as3 data-lang=as3><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>local</span> <span style=color:#111>prometheus</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>import</span> <span style=color:#d88200>&#34;prometheus-ksonnet/prometheus-ksonnet.libsonnet&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>prometheus</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#111>_config</span><span style=color:#f92672>+::</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>namespace</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#34;default&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></div><p>Apply your config:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ks apply default
</span></span></code></pre></div><h2 id=using-kube-prometheus>Using kube-prometheus</h2><p>See the kube-prometheus docs for <a href=https://github.com/coreos/kube-prometheus#kube-prometheus>instructions on how to use mixins with kube-prometheus</a>.</p><h2 id=customising-the-mixin>Customising the mixin</h2><p>Mixins typically allows you to override the selectors used for various jobs,
to match those used in your Prometheus set.</p><p>This example uses the <a href=https://github.com/kubernetes-monitoring/kubernetes-mixin>kubernetes-mixin</a>.
In a new directory, add a file <code>mixin.libsonnet</code>:</p><div class=position-relative><div class=position-absolute style=right:0><button class="btn btn-light" data-clipboard-target=#clipboard_1e83f0d618>
Copy</button></div><div id=clipboard_1e83f0d618><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-as3 data-lang=as3><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>local</span> <span style=color:#111>kubernetes</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>import</span> <span style=color:#d88200>&#34;kubernetes-mixin/mixin.libsonnet&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>kubernetes</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#111>_config</span><span style=color:#f92672>+::</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>kubeStateMetricsSelector</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;job=&#34;kube-state-metrics&#34;&#39;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>cadvisorSelector</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;job=&#34;kubernetes-cadvisor&#34;&#39;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>nodeExporterSelector</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;job=&#34;kubernetes-node-exporter&#34;&#39;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>kubeletSelector</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;job=&#34;kubernetes-kubelet&#34;&#39;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></div><p>Then, install the kubernetes-mixin:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ jb init
</span></span><span style=display:flex><span>$ jb install github.com/kubernetes-monitoring/kubernetes-mixin
</span></span></code></pre></div><p>Generate the alerts, rules and dashboards:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir files
</span></span><span style=display:flex><span>$ jsonnet -J vendor -S -e <span style=color:#d88200>&#39;std.manifestYamlDoc((import &#34;mixin.libsonnet&#34;).prometheusAlerts)&#39;</span> &gt; files/alerts.yml
</span></span><span style=display:flex><span>$ jsonnet -J vendor -S -e <span style=color:#d88200>&#39;std.manifestYamlDoc((import &#34;mixin.libsonnet&#34;).prometheusRules)&#39;</span> &gt; files/rules.yml
</span></span><span style=display:flex><span>$ mkdir files/dashboards
</span></span><span style=display:flex><span>$ jsonnet -J vendor -m files/dashboards -e <span style=color:#d88200>&#39;(import &#34;mixin.libsonnet&#34;).grafanaDashboards&#39;</span>
</span></span></code></pre></div><h2 id=guidelines-for-alert-names-labels-and-annotations>Guidelines for alert names, labels, and annotations</h2><p>Prometheus alerts deliberately allow users to define their own schema for
names, labels, and annotations. The following is a style guide recommended for
alerts in monitoring mixins. Following this guide helps creating useful
notification templates for all mixins and customizing mixin alerts in a unified
fashion.</p><p>The alert <strong>name</strong> is a terse description of the alerting condition, using
camel case, without whitespace, starting with a capital letter. The first
component of the name should be shared between all alerts of a mixin (or
between a group of related alerts within a larger mixin). Examples:
<code>NodeFilesystemAlmostOutOfFiles</code> (from the <a href=https://github.com/prometheus/node_exporter/tree/master/docs/node-mixin>node-exporter
mixin</a>,
<code>PrometheusNotificationQueueRunningFull</code> (from the <a href=https://github.com/prometheus/prometheus/blob/master/documentation/prometheus-mixin>Prometheus
mixin</a>).</p><p>To mark the severity of an alert, use a <strong>label</strong> called <code>severity</code> with one of
the following label values:</p><ul><li><code>critical</code> for alerts that require immediate action. For a production system,
those alerts will usually hit a pager.</li><li><code>warning</code> for alerts that require action eventually but not urgently enough
to wake someone up or require them to immediately interrupt what they are
working on. A typical routing target for those alerts is some kind of ticket
queueing or bug tracking system.</li><li><code>info</code> for alerts that do not require any action by itself but mark something
as “out of the ordinary”. Those alerts aren&rsquo;t usually routed anywhere, but
can be inspected during troubleshooting.</li></ul><p>An alert can have the following <strong>annotations</strong>:</p><ul><li><code>summary</code> (mandatory): Essentially a more comprehensive and readable version
of the alert name. Use a human-readable sentence, starting with a capital
letter and ending with a period. Use a static string or, if dynamic expansion
is needed, aim for expanding into the same string for alerts that are
typically grouped together into one notification. In that way, it can be used
as a common “headline” for all alerts in the notification template. Examples:
<code>Filesystem has less than 3% inodes left.</code> (for the
<code>NodeFilesystemAlmostOutOfFiles</code> alert mentioned above), <code>Prometheus alert notification queue predicted to run full in less than 30m.</code> (for the
<code>PrometheusNotificationQueueRunningFull</code> alert mentioned above).</li><li><code>description</code> (mandatory): A detailed description of a single alert, with
most of the important information templated in. The description usually
expands into a different string for every individual alert within a
notification. A notification template can iterate through all the
descriptions and format them into a list. Examples (again corresponding to
the examples above): <code>Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available inodes left.</code>, <code>Alert notification queue of Prometheus %(prometheusName)s is running full.</code>.</li></ul><p>Note that we plan to add recommended optional annotations for a runbook link
(presumably called <code>runbook_url</code>) and a dashboard link
(<code>dashboard_url</code>). However, we still need to work out how to configure patterns
for those URLs across mixins in a useful way.</p><div class=row></div></div></div></div><script src=https://stack.observability.udmire.cn/lib/jquery.min.js></script><script src=https://stack.observability.udmire.cn/lib/popper.min.js></script><script src=https://stack.observability.udmire.cn/js/bootstrap.min.js></script><script type=text/javascript src=/plugins/lunr.min.js></script><script type=text/javascript src=/plugins/auto-complete.js></script><link href=/plugins/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https://stack.observability.udmire.cn/"</script><script type=text/javascript src=/plugins/search.js></script><script type=text/javascript src=/plugins/clipboard.js></script><script>new ClipboardJS(".btn")</script></body></html>